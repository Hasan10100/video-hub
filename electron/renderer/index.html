<!doctype html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>Video Hub</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <h2>Video Hub (Desktop)</h2>

    <div class="card">

        <!-- ================= SCREEN: LOGIN ================= -->
        <div id="screenLogin">
            <h3>Login</h3>

            <input id="email" placeholder="email" value="admin@test.com" style="width:320px;" />
            <br /><br />
            <input id="password" type="password" placeholder="password" value="password123" style="width:320px;" />
            <br /><br />

            <button id="loginBtn">Login</button>

            <h3>Register</h3>

            <input id="name" placeholder="name" style="width:320px;" />
            <br /><br />
            <input id="emailRe" placeholder="email" style="width:320px;" />
            <br /><br />
            <input id="passwordRe" type="password" placeholder="password" style="width:320px;" />
            <br /><br />

            <button id="registerBtn">Register</button>

            <pre id="authOut"></pre>
        </div>

        <!-- ================= SCREEN: HOME (LIBRARY) ================= -->
        <div id="screenHome" style="display:none;">

            <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
                <h3 style="margin:0;">Library</h3>
                <button id="logoutBtn">Logout</button>
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap; margin:10px 0;">
                <button id="tileAll">All Videos</button>
                <button id="tileLocal">Local</button>
                <button id="tileExternal">External</button>
            </div>

            <button id="refreshBtn">Refresh Library</button>

            <div class="panel" style="margin-top:10px;">
                <h4>Player</h4>
                <div id="libNowPlaying" class="sub"></div>
                <video id="libPlayer" controls style="width:100%; max-width:720px; margin-top:10px;"></video>
            </div>

            <ul id="videoList"></ul>

            <hr />

            <h3>Playlists</h3>
            <input id="plName" placeholder="New playlist name" />
            <button id="plCreateBtn">Create</button>
            <button id="plRefreshBtn">Refresh</button>

            <h4 style="margin-top:10px;">Playlist Tiles</h4>
            <ul id="plList"></ul>
        </div>

        <!-- ================= SCREEN: PLAYLIST VIEW ================= -->
        <div id="screenPlaylist" style="display:none;">

            <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
                <button id="backHomeBtn">‚Üê Back to Library</button>
                <button id="logoutBtn2">Logout</button>
            </div>

            <h3 style="margin-top:10px;">Playlist: <span id="plTitle">None</span></h3>

            <div class="panel" style="margin-top:10px;">
                <h4>Add External Video</h4>
                <input id="extTitle" placeholder="Title" style="width:320px;" />
                <br /><br />
                <input id="extUrl" placeholder="https://..." style="width:320px;" />
                <br /><br />
                <button id="addExternalBtn">Add External</button>
                <pre id="externalOut"></pre>
            </div>

            <div class="panel" style="margin-top:10px;">
                <h4>Import Local Video</h4>
                <button id="importBtn">Import Video</button>
                <pre id="importOut"></pre>
            </div>

            <div class="panel" style="margin-top:10px;">
                <button id="toggleAddFromLibrary" style="margin-bottom:8px;">
                    Add from Library
                </button>

                <div id="addFromLibraryPanel" style="display:none;">
                    <input id="libSearch" placeholder="Search library..." style="width:100%; margin-bottom:8px;" />
                    <ul id="libAddList"></ul>
                </div>
            </div>

            <video id="player" controls style="width:100%; max-width:720px; margin-top:10px;"></video>

            <div class="panel" style="margin-top:10px;">
                <h4>Playlist Items</h4>
                <ul id="plItems"></ul>
            </div>

        </div>
    </div>

    <script>
        // ------------------ App State ------------------
        let isAuthenticated = false;
        let currentPlaylistId = null;
        let currentFilter = "all"; // all | local | external
        window._videosCache = [];

        // Avoid overlapping playlist refreshes (prevents short "stuck" UI)
        let _refreshPlaylistsInFlight = false;

        // ------------------ Screen Router ------------------
        function showScreen(name) {
            document.getElementById("screenLogin").style.display = (name === "login") ? "" : "none";
            document.getElementById("screenHome").style.display = (name === "home") ? "" : "none";
            document.getElementById("screenPlaylist").style.display = (name === "playlist") ? "" : "none";
        }

        // ------------------ Helpers: Players ------------------
        function resetLibraryPlayer() {
            if (!libPlayer) return;

            try {
                libPlayer.pause();
            } catch {}

            libPlayer.removeAttribute("src");
            libPlayer.load();
            libNowPlaying.textContent = "";
        }

        function resetPlaylistPlayer() {
            if (!player) return;

            try {
                player.pause();
            } catch {}

            player.removeAttribute("src");
            player.load();
        }

        function resetAddFromLibraryUI() {
            if (libSearch) {
                libSearch.value = "";
            }

            if (typeof renderAddFromLibraryList === "function") {
                renderAddFromLibraryList("");
            }

            const panel = document.getElementById("addFromLibraryPanel");
            const btn = document.getElementById("toggleAddFromLibrary");

            if (panel) panel.style.display = "none";
            if (btn) btn.textContent = "Add from Library";
        }

        function setAuthenticatedUI(isAuthed) {
            isAuthenticated = isAuthed;

            if (!isAuthed) {
                currentPlaylistId = null;
                window._videosCache = [];

                resetPlaylistPlayer();
                resetLibraryPlayer();
                resetAddFromLibraryUI();

                if (videoList) videoList.innerHTML = "";
                if (plList) plList.innerHTML = "";
                if (plItems) plItems.innerHTML = "";
                if (plTitle) plTitle.textContent = "None";

                showScreen("login");
            }
        }

        function isDirectMediaUrl(url) {
            try {
                return /\.(mp4|webm|ogg)$/i.test(new URL(url).pathname);
            } catch {
                return false;
            }
        }

        function applyLibraryFilter(videos) {
            if (currentFilter === "local") return videos.filter(v => v.sourceType === "local");
            if (currentFilter === "external") return videos.filter(v => v.sourceType === "external");
            return videos;
        }

        function getNewVideoId(r) {
            return r?.video?._id || null;
        }

        // ------------------ DOM refs ------------------
        const nameRe = document.getElementById("name");
        const emailRe = document.getElementById("emailRe");
        const passwordRe = document.getElementById("passwordRe");

        const emailEl = document.getElementById("email");
        const passwordEl = document.getElementById("password");
        const authOut = document.getElementById("authOut");

        const videoList = document.getElementById("videoList");
        const plList = document.getElementById("plList");
        const plItems = document.getElementById("plItems");
        const plTitle = document.getElementById("plTitle");

        const libPlayer = document.getElementById("libPlayer");
        const libNowPlaying = document.getElementById("libNowPlaying");
        const player = document.getElementById("player");

        const libSearch = document.getElementById("libSearch");
        const libAddList = document.getElementById("libAddList");

        // ------------------ Auth ------------------
        async function register() {
            const r = await window.api.auth.register({
                name: nameRe.value,
                email: emailRe.value,
                password: passwordRe.value
            });

            if (r.ok) {
                setAuthenticatedUI(true);
                nameRe.value = "";
                emailRe.value = "";
                passwordRe.value = "";
                showScreen("home");
                await refreshLibrary();
                await refreshPlaylists();
            } else {
                if (authOut) authOut.textContent = JSON.stringify(r, null, 2);
            }
        }

        async function login() {
            const r = await window.api.auth.login({
                email: emailEl.value,
                password: passwordEl.value
            });

            if (r.ok) {
                setAuthenticatedUI(true);
                showScreen("home");
                await refreshLibrary();
                await refreshPlaylists();
            } else {
                if (authOut) authOut.textContent = JSON.stringify(r, null, 2);
            }
        }

        async function logout() {
            await window.api.auth.logout();
            setAuthenticatedUI(false);
        }

        // ------------------ Library ------------------
        function renderLibraryList(videos) {
            videoList.innerHTML = "";

            for (const v of videos) {
                const li = document.createElement("li");

                const label = document.createElement("span");
                label.textContent = v.sourceType === "external" ? `${v.title} (external)` : v.title;
                label.style.cursor = "pointer";

                label.onclick = async () => {
                    resetPlaylistPlayer();

                    libNowPlaying.textContent = `Now playing: ${v.title}`;

                    if (v.sourceType === "local") {
                        if (!v.fileUrl) return alert("Missing fileUrl. Refresh library.");
                        libPlayer.src = v.fileUrl;
                        try { await libPlayer.play(); } catch {}
                        return;
                    }

                    if (isDirectMediaUrl(v.externalUrl)) {
                        libPlayer.src = v.externalUrl;
                        try { await libPlayer.play(); } catch {}
                    } else {
                        await window.api.videos.openExternal(v.externalUrl);
                        libNowPlaying.textContent = `Opened externally: ${v.title}`;
                    }
                };

                const del = document.createElement("button");
                del.textContent = "Delete";
                del.style.marginLeft = "10px";

                del.onclick = async () => {
                    if (!confirm(`Delete "${v.title}"?`)) return;
                    await window.api.videos.delete(v._id);
                    await refreshLibrary();
                    if (currentPlaylistId) await loadPlaylist(currentPlaylistId);
                };

                li.append(label, del);
                videoList.appendChild(li);
            }
        }

        async function refreshLibrary() {
            if (!isAuthenticated) return;

            const r = await window.api.videos.list();
            if (!r.ok) {
                videoList.innerHTML = `<li>${r.message || "Failed to load videos"}</li>`;
                return;
            }

            window._videosCache = r.videos;

            const filtered = applyLibraryFilter(r.videos);
            renderLibraryList(filtered);

            if (currentPlaylistId) {
                renderAddFromLibraryList(libSearch ? libSearch.value.toLowerCase() : "");
            }
        }

        // ------------------ Playlists ------------------
        async function refreshPlaylists() {
            if (!isAuthenticated) return;
            if (_refreshPlaylistsInFlight) return;

            _refreshPlaylistsInFlight = true;

            try {
                const r = await window.api.playlists.list();

                // Guard again after await (state can change while waiting)
                if (!isAuthenticated) return;

                plList.innerHTML = "";
                if (!r.ok) return;

                for (const p of r.playlists) {
                    const li = document.createElement("li");
                    li.style.display = "flex";
                    li.style.justifyContent = "space-between";
                    li.style.alignItems = "center";

                    // Playlist name (clickable)
                    const label = document.createElement("span");
                    label.textContent = p.name;
                    label.style.cursor = "pointer";

                    label.onclick = async () => {
                        await loadPlaylist(p._id);
                        showScreen("playlist");
                    };

                    // Delete button
                    const del = document.createElement("button");
                    del.textContent = "Delete";
                    del.style.marginLeft = "10px";

                    del.onclick = async (e) => {
                        e.stopPropagation();
                        <!-- if (!confirm(`Delete playlist "${p.name}"?`)) return; -->

                        // Disable button to prevent double clicks
                        del.disabled = true;

                        // Optimistic UI: remove the tile immediately to avoid UI "stuck"
                        li.remove();

                        const playlistId = String(p._id);
                        const result = await window.api.playlists.deleteplaylist(playlistId);

                        if (!result.ok) {
                            alert(result.message || "Failed to delete playlist");
                            // If delete failed, reload list from server
                            await refreshPlaylists();
                            return;
                        }

                        if (currentPlaylistId === playlistId) {
                            currentPlaylistId = null;
                            showScreen("home");
                        }

                        // No need to refresh if optimistic removal succeeded,
                        // but you can refresh to ensure server is in sync.
                        // await refreshPlaylists();
                    };

                    li.append(label, del);
                    plList.appendChild(li);
                }
            } finally {
                _refreshPlaylistsInFlight = false;
            }
        }

        async function loadPlaylist(id) {
            if (!isAuthenticated) return;

            resetPlaylistPlayer();
            resetLibraryPlayer();
            resetAddFromLibraryUI();

            currentPlaylistId = id;

            const r = await window.api.playlists.getlist(id);
            if (!r.ok) return;

            plTitle.textContent = r.playlist.name;
            plItems.innerHTML = "";

            for (const v of r.playlist.videoIds) {
                const li = document.createElement("li");
                li.dataset.videoId = v._id;

                const label = document.createElement("span");
                label.textContent = `${v.title} (${v.sourceType})`;
                label.style.cursor = "pointer";

                label.onclick = async () => {
                    resetLibraryPlayer();

                    if (v.sourceType === "local") {
                        const m = window._videosCache.find(x => x._id === v._id);
                        if (m?.fileUrl) player.src = m.fileUrl;
                    } else {
                        await window.api.videos.openExternal(v.externalUrl);
                    }
                };

                const rm = document.createElement("button");
                rm.textContent = "Remove";
                rm.style.marginLeft = "10px";

                rm.onclick = async () => {
                    await window.api.playlists.removeitem({ playlistId: id, videoId: v._id });
                    await loadPlaylist(id);
                };

                li.append(label, rm);
                plItems.appendChild(li);
            }

            renderAddFromLibraryList("");
        }

        // ------------------ Add From Library Panel ------------------
        function renderAddFromLibraryList(filterText = "") {
            if (!libAddList) return;

            libAddList.innerHTML = "";

            const playlistVideoIds = new Set(
                Array.from(plItems.children).map(li => li.dataset.videoId)
            );

            for (const v of window._videosCache) {
                if (filterText && !v.title.toLowerCase().includes(filterText)) continue;

                const li = document.createElement("li");
                li.style.display = "flex";
                li.style.justifyContent = "space-between";
                li.style.alignItems = "center";

                const label = document.createElement("span");
                label.textContent = `${v.title} (${v.sourceType})`;

                const btn = document.createElement("button");

                if (playlistVideoIds.has(v._id)) {
                    btn.textContent = "Added";
                    btn.disabled = true;
                } else {
                    btn.textContent = "Add";
                    btn.onclick = async () => {
                        await window.api.playlists.additem({
                            playlistId: currentPlaylistId,
                            videoId: v._id
                        });

                        await loadPlaylist(currentPlaylistId);
                        renderAddFromLibraryList(libSearch ? libSearch.value.toLowerCase() : "");
                    };
                }

                li.append(label, btn);
                libAddList.appendChild(li);
            }
        }

        // ------------------ Upload / Import (auto-add to playlist) ------------------
        async function uploadExternal() {
            if (!currentPlaylistId) return alert("Open a playlist first.");

            const title = extTitle.value.trim();
            const externalUrl = extUrl.value.trim();
            if (!title || !externalUrl) return alert("Title and URL required");

            const r = await window.api.videos.upload({ title, externalUrl });
            externalOut.textContent = JSON.stringify(r, null, 2);
            if (!r.ok) return;

            const newVideoId = getNewVideoId(r);
            if (!newVideoId) return alert("Missing video._id in response.");

            await refreshLibrary();
            await window.api.playlists.additem({ playlistId: currentPlaylistId, videoId: newVideoId });
            await loadPlaylist(currentPlaylistId);

            extTitle.value = "";
            extUrl.value = "";
        }

        async function importLocal() {
            if (!currentPlaylistId) return alert("Open a playlist first.");

            const r = await window.api.videos.import();
            importOut.textContent = JSON.stringify(r, null, 2);
            if (!r.ok) return;

            const newVideoId = getNewVideoId(r);
            if (!newVideoId) return alert("Missing video._id in response.");

            await refreshLibrary();
            await window.api.playlists.additem({ playlistId: currentPlaylistId, videoId: newVideoId });
            await loadPlaylist(currentPlaylistId);

            const v = window._videosCache.find(x => x._id === newVideoId);
            if (v?.fileUrl) player.src = v.fileUrl;
        }

        // ------------------ Wire up events ------------------
        document.getElementById("registerBtn").onclick = register;
        document.getElementById("loginBtn").onclick = login;

        document.getElementById("logoutBtn").onclick = logout;
        document.getElementById("logoutBtn2").onclick = logout;

        document.getElementById("refreshBtn").onclick = refreshLibrary;

        document.getElementById("tileAll").onclick = async () => {
            currentFilter = "all";
            await refreshLibrary();
        };

        document.getElementById("tileLocal").onclick = async () => {
            currentFilter = "local";
            await refreshLibrary();
        };

        document.getElementById("tileExternal").onclick = async () => {
            currentFilter = "external";
            await refreshLibrary();
        };

        document.getElementById("plCreateBtn").onclick = async () => {
            if (!plName.value.trim()) return;

            // Simple UI safety: prevent double create clicks
            const btn = document.getElementById("plCreateBtn");
            btn.disabled = true;

            try {
                await window.api.playlists.create(plName.value.trim());
                plName.value = "";
                await refreshPlaylists();
            } finally {
                btn.disabled = false;
            }
        };

        document.getElementById("plRefreshBtn").onclick = refreshPlaylists;

        document.getElementById("addExternalBtn").onclick = uploadExternal;
        document.getElementById("importBtn").onclick = importLocal;

        document.getElementById("backHomeBtn").onclick = () => {
            resetPlaylistPlayer();
            resetLibraryPlayer();
            resetAddFromLibraryUI();
            currentPlaylistId = null;
            showScreen("home");
        };

        document.getElementById("toggleAddFromLibrary").onclick = () => {
            const panel = document.getElementById("addFromLibraryPanel");
            const btn = document.getElementById("toggleAddFromLibrary");

            const isHidden = panel.style.display === "none";

            panel.style.display = isHidden ? "" : "none";
            btn.textContent = isHidden ? "Hide Library" : "Add from Library";

            if (isHidden) {
                renderAddFromLibraryList(libSearch ? libSearch.value.toLowerCase() : "");
            }
        };

        if (libSearch) {
            libSearch.oninput = () => {
                renderAddFromLibraryList(libSearch.value.toLowerCase());
            };
        }

        // ------------------ Boot ------------------
        showScreen("login");
    </script>

</body>
</html>
