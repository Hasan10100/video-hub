<!doctype html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>Video Hub</title>
    <link rel="stylesheet" href="./src/index.css">
</head>

<body>
    <h2>Video Hub (Desktop)</h2>

    <div class="card">

        <!-- ================= SCREEN: LIBRARY ================= -->
        <div id="screenLibrary">

            <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
                <h3 style="margin:0;">Library</h3>
                <span id="healthBadge">Checking…</span>
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap; margin:10px 0;">
                <button id="btnRefresh">Refresh</button>

                <button id="btnFilterAll" class="primary">All</button>
                <button id="btnFilterLocal">Local</button>
                <button id="btnFilterExternal">External</button>

                <input id="searchBox" placeholder="Search titles…" style="min-width:220px;" />
            </div>

            <div style="margin:12px 0;">
                <h4 style="margin:0 0 6px 0;">Player</h4>
                <div id="nowPlaying" style="opacity:0.8;"></div>
                <video id="libraryPlayer" controls style="width:100%; max-width:820px; margin-top:8px;"></video>
                <div id="playerHint" style="margin-top:6px; opacity:0.75;"></div>
            </div>

            <h4>Videos</h4>
            <ul id="videoList"></ul>

            <hr />

            <div style="display:flex; align-items:flex-end; gap:10px; flex-wrap:wrap;">
                <div>
                    <h3 style="margin:0 0 6px 0;">Playlists</h3>
                    <input id="playlistName" placeholder="New playlist name" />
                </div>
                <button id="btnCreatePlaylist" class="primary">Create</button>
                <button id="btnRefreshPlaylists">Refresh Playlists</button>
            </div>

            <ul id="playlistList" style="margin-top:10px;"></ul>
        </div>

        <!-- ================= SCREEN: PLAYLIST ================= -->
        <div id="screenPlaylist" style="display:none;">

            <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
                <button id="btnBack">← Back</button>
                <div style="opacity:0.8;">Playlist View</div>
            </div>

            <h3 style="margin-top:10px;">Playlist: <span id="playlistTitle">—</span></h3>

            <div style="margin:10px 0;">
                <h4 style="margin:0 0 6px 0;">Playlist Player</h4>
                <video id="playlistPlayer" controls style="width:100%; max-width:820px;"></video>
            </div>

            <div style="display:flex; gap:18px; flex-wrap:wrap; margin:14px 0;">
                <div style="min-width:280px;">
                    <h4 style="margin:0 0 8px 0;">Import Local Video</h4>
                    <button id="btnImportLocal" class="primary">Import</button>
                    <pre id="importOut" style="white-space:pre-wrap;"></pre>
                </div>

                <div style="min-width:280px;">
                    <h4 style="margin:0 0 8px 0;">Add External Link</h4>
                    <input id="externalTitle" placeholder="Title" style="width:100%;" />
                    <div style="height:8px;"></div>
                    <input id="externalUrl" placeholder="https://..." style="width:100%;" />
                    <div style="height:8px;"></div>
                    <button id="btnAddExternal" class="primary">Add</button>
                    <pre id="externalOut" style="white-space:pre-wrap;"></pre>
                </div>
            </div>

            <div style="margin:10px 0;">
                <button id="btnToggleAddFromLibrary">Add from Library</button>
                <div id="addFromLibraryPanel" style="display:none; margin-top:10px;">
                    <input id="librarySearchInPlaylist" placeholder="Search library…" style="width:100%; max-width:420px;" />
                    <ul id="libraryAddList"></ul>
                </div>
            </div>

            <h4>Playlist Items</h4>
            <ul id="playlistItems"></ul>
        </div>

    </div>

    <script>
        // ------------------ State ------------------
        let videosCache = [];
        let playlistsCache = [];
        let currentFilter = "all"; // all | local | external (client-side filter because preload videos.list() has no args)
        let currentQuery = "";
        let currentPlaylistId = null;

        // ------------------ DOM ------------------
        const screenLibrary = document.getElementById("screenLibrary");
        const screenPlaylist = document.getElementById("screenPlaylist");

        const healthBadge = document.getElementById("healthBadge");

        const searchBox = document.getElementById("searchBox");
        const videoList = document.getElementById("videoList");

        const libraryPlayer = document.getElementById("libraryPlayer");
        const playlistPlayer = document.getElementById("playlistPlayer");
        const nowPlaying = document.getElementById("nowPlaying");
        const playerHint = document.getElementById("playerHint");

        const playlistName = document.getElementById("playlistName");
        const playlistList = document.getElementById("playlistList");

        const playlistTitle = document.getElementById("playlistTitle");
        const playlistItems = document.getElementById("playlistItems");

        const importOut = document.getElementById("importOut");
        const externalOut = document.getElementById("externalOut");
        const externalTitle = document.getElementById("externalTitle");
        const externalUrl = document.getElementById("externalUrl");

        const addFromLibraryPanel = document.getElementById("addFromLibraryPanel");
        const librarySearchInPlaylist = document.getElementById("librarySearchInPlaylist");
        const libraryAddList = document.getElementById("libraryAddList");

        // ------------------ Screen helpers ------------------
        function showLibrary() {
            screenLibrary.style.display = "";
            screenPlaylist.style.display = "none";
            currentPlaylistId = null;
            resetPlayer(playlistPlayer);
            renderAddFromLibraryList();
        }

        function showPlaylist() {
            screenLibrary.style.display = "none";
            screenPlaylist.style.display = "";
            resetPlayer(libraryPlayer);
        }

        function resetPlayer(el) {
            try { el.pause(); } catch {}
            el.removeAttribute("src");
            el.load();
        }

        // ------------------ Health ------------------
        async function refreshHealth() {
            try {
                const r = await window.api.getHealth();
                healthBadge.textContent = r?.ok ? `OK (${r.mode || "desktop"})` : "Unavailable";
            } catch {
                healthBadge.textContent = "Unavailable";
            }
        }

        // ------------------ Library: fetch + render ------------------
        async function fetchVideos() {
            // preload signature: videos.list() -> no args
            const r = await window.api.videos.list();
            if (!r?.ok) {
                videosCache = [];
                return;
            }
            videosCache = r.items || [];
        }

        function getVisibleVideos() {
            const q = (currentQuery || "").trim().toLowerCase();

            return videosCache.filter((v) => {
                const typeOk = (currentFilter === "all") ? true : (v.sourceType === currentFilter);
                const qOk = q ? (String(v.title || "").toLowerCase().includes(q)) : true;
                return typeOk && qOk;
            });
        }

        function renderVideos() {
            const visible = getVisibleVideos();
            videoList.innerHTML = "";

            if (!visible.length) {
                videoList.innerHTML = `<li style="opacity:0.75;">No videos found.</li>`;
                return;
            }

            for (const v of visible) {
                const li = document.createElement("li");
                li.style.display = "flex";
                li.style.justifyContent = "space-between";
                li.style.alignItems = "center";
                li.style.gap = "10px";

                const left = document.createElement("div");
                left.style.cursor = "pointer";
                left.style.flex = "1";

                const tag = v.sourceType === "external" ? "external" : (v.missing ? "missing" : "local");
                left.textContent = `${v.title} (${tag})`;

                left.onclick = async () => playVideoInLibrary(v);

                const right = document.createElement("div");

                const del = document.createElement("button");
                del.textContent = "Delete";
                del.className = "danger";

                del.onclick = async () => {
                    if (!confirm(`Delete "${v.title}"?`)) return;
                    await window.api.videos.delete(v.id);
                    await refreshAll();
                };

                right.appendChild(del);
                li.appendChild(left);
                li.appendChild(right);
                videoList.appendChild(li);
            }
        }

        async function playVideoInLibrary(v) {
            resetPlayer(playlistPlayer);

            nowPlaying.textContent = `Now playing: ${v.title}`;
            playerHint.textContent = "";

            if (v.sourceType === "local") {
                if (!v.fileUrl) {
                    playerHint.textContent = v.missing ? "File is missing on disk." : "Missing fileUrl.";
                    return;
                }

                libraryPlayer.src = v.fileUrl;

                try {
                    await libraryPlayer.play();
                } catch (err) {
                    // Common in dev when renderer is http://localhost and media is file://
                    playerHint.textContent =
                        "Could not play local file in this mode. If you are running dev (Vite URL), local file:// playback may be blocked. Try packaged/prod, or serve local videos via a custom protocol.";
                    console.error(err);
                }

                return;
            }

            // External
            if (v.externalUrl) {
                await window.api.videos.openExternal(v.externalUrl);
                playerHint.textContent = "Opened external link in your browser.";
            }
        }

        // ------------------ Playlists: fetch + render ------------------
        async function fetchPlaylists() {
            const r = await window.api.playlists.list();
            playlistsCache = r?.ok ? (r.items || []) : [];
        }

        function renderPlaylists() {
            playlistList.innerHTML = "";

            if (!playlistsCache.length) {
                playlistList.innerHTML = `<li style="opacity:0.75;">No playlists yet.</li>`;
                return;
            }

            for (const p of playlistsCache) {
                const li = document.createElement("li");
                li.style.display = "flex";
                li.style.justifyContent = "space-between";
                li.style.alignItems = "center";
                li.style.gap = "10px";

                const left = document.createElement("div");
                left.style.cursor = "pointer";
                left.style.flex = "1";
                left.textContent = p.name;

                left.onclick = async () => {
                    await openPlaylist(p.id);
                };

                const right = document.createElement("div");

                const del = document.createElement("button");
                del.textContent = "Delete";
                del.className = "danger";

                del.onclick = async (e) => {
                    e.stopPropagation();
                    if (!confirm(`Delete playlist "${p.name}"?`)) return;
                    await window.api.playlists.deleteplaylist(p.id);
                    await refreshPlaylistsOnly();
                };

                right.appendChild(del);
                li.appendChild(left);
                li.appendChild(right);

                playlistList.appendChild(li);
            }
        }

        async function openPlaylist(id) {
            currentPlaylistId = id;

            const r = await window.api.playlists.getlist(id);
            if (!r?.ok) {
                alert(r?.message || "Failed to load playlist");
                return;
            }

            playlistTitle.textContent = r.playlist?.name || "Unnamed";
            renderPlaylistItems(r.items || []);

            // Update library add list from current cached videos
            renderAddFromLibraryList();

            showPlaylist();
        }

        function renderPlaylistItems(items) {
            playlistItems.innerHTML = "";

            if (!items.length) {
                playlistItems.innerHTML = `<li style="opacity:0.75;">No items in this playlist.</li>`;
                return;
            }

            for (const v of items) {
                const li = document.createElement("li");
                li.style.display = "flex";
                li.style.justifyContent = "space-between";
                li.style.alignItems = "center";
                li.style.gap = "10px";
                li.dataset.videoId = String(v.id);

                const left = document.createElement("div");
                left.style.cursor = "pointer";
                left.style.flex = "1";
                left.textContent = `${v.title} (${v.sourceType})`;

                left.onclick = async () => playVideoInPlaylist(v);

                const right = document.createElement("div");

                const rm = document.createElement("button");
                rm.textContent = "Remove";

                rm.onclick = async () => {
                    await window.api.playlists.removeitem({ playlistId: currentPlaylistId, videoId: v.id });
                    await openPlaylist(currentPlaylistId);
                };

                right.appendChild(rm);
                li.appendChild(left);
                li.appendChild(right);

                playlistItems.appendChild(li);
            }
        }

        async function playVideoInPlaylist(v) {
            resetPlayer(libraryPlayer);

            if (v.sourceType === "local") {
                if (!v.fileUrl) {
                    alert(v.missing ? "File missing on disk." : "Missing fileUrl.");
                    return;
                }

                playlistPlayer.src = v.fileUrl;

                try {
                    await playlistPlayer.play();
                } catch (err) {
                    alert("Could not play local file in this mode. See console for details.");
                    console.error(err);
                }

                return;
            }

            if (v.externalUrl) {
                await window.api.videos.openExternal(v.externalUrl);
            }
        }

        // ------------------ Add From Library inside playlist ------------------
        function renderAddFromLibraryList() {
            if (!currentPlaylistId) {
                libraryAddList.innerHTML = "";
                return;
            }

            const q = (librarySearchInPlaylist.value || "").trim().toLowerCase();
            const existingIds = new Set(Array.from(playlistItems.children).map((li) => li.dataset.videoId));

            libraryAddList.innerHTML = "";

            const candidates = videosCache.filter((v) => {
                if (!q) return true;
                return String(v.title || "").toLowerCase().includes(q);
            });

            if (!candidates.length) {
                libraryAddList.innerHTML = `<li style="opacity:0.75;">No library videos found.</li>`;
                return;
            }

            for (const v of candidates) {
                const li = document.createElement("li");
                li.style.display = "flex";
                li.style.justifyContent = "space-between";
                li.style.alignItems = "center";
                li.style.gap = "10px";

                const left = document.createElement("div");
                left.style.flex = "1";
                left.textContent = `${v.title} (${v.sourceType})`;

                const btn = document.createElement("button");

                if (existingIds.has(String(v.id))) {
                    btn.textContent = "Added";
                    btn.disabled = true;
                } else {
                    btn.textContent = "Add";
                    btn.onclick = async () => {
                        await window.api.playlists.additem({ playlistId: currentPlaylistId, videoId: v.id });
                        await openPlaylist(currentPlaylistId);
                    };
                }

                li.appendChild(left);
                li.appendChild(btn);
                libraryAddList.appendChild(li);
            }
        }

        // ------------------ Actions: import / external ------------------
        async function doImportLocal() {
            if (!currentPlaylistId) return;

            const r = await window.api.videos.import();
            importOut.textContent = JSON.stringify(r, null, 2);

            if (!r?.ok) return;

            await fetchVideos();
            await window.api.playlists.additem({ playlistId: currentPlaylistId, videoId: r.item.id });
            await openPlaylist(currentPlaylistId);
            renderVideos();
        }

        async function doAddExternal() {
            if (!currentPlaylistId) return;

            const title = externalTitle.value.trim();
            const url = externalUrl.value.trim();

            if (!title || !url) {
                alert("Title and URL required");
                return;
            }

            const r = await window.api.videos.upload({ title, externalUrl: url });
            externalOut.textContent = JSON.stringify(r, null, 2);

            if (!r?.ok) return;

            externalTitle.value = "";
            externalUrl.value = "";

            await fetchVideos();
            await window.api.playlists.additem({ playlistId: currentPlaylistId, videoId: r.item.id });
            await openPlaylist(currentPlaylistId);
            renderVideos();
        }

        // ------------------ Refresh flows ------------------
        async function refreshAll() {
            await refreshHealth();
            await fetchVideos();
            await fetchPlaylists();
            renderVideos();
            renderPlaylists();
        }

        async function refreshPlaylistsOnly() {
            await fetchPlaylists();
            renderPlaylists();
        }

        // ------------------ Wire events ------------------
        document.getElementById("btnRefresh").onclick = refreshAll;

        document.getElementById("btnFilterAll").onclick = () => {
            currentFilter = "all";
            renderVideos();
        };

        document.getElementById("btnFilterLocal").onclick = () => {
            currentFilter = "local";
            renderVideos();
        };

        document.getElementById("btnFilterExternal").onclick = () => {
            currentFilter = "external";
            renderVideos();
        };

        searchBox.oninput = () => {
            currentQuery = searchBox.value;
            renderVideos();
        };

        document.getElementById("btnCreatePlaylist").onclick = async () => {
            const name = playlistName.value.trim();
            if (!name) return;

            // preload signature: create(playlistName)
            const r = await window.api.playlists.create(name);

            // NOTE: with your current preload.js, main.js expects { name }, but preload sends { playlistName }.
            // So r may be { ok:false }. We'll show it.
            if (!r?.ok) {
                alert(r?.message || "Create playlist failed (likely preload payload mismatch). See note in preload patch below.");
                return;
            }

            playlistName.value = "";
            await refreshPlaylistsOnly();
        };

        document.getElementById("btnRefreshPlaylists").onclick = refreshPlaylistsOnly;

        document.getElementById("btnBack").onclick = showLibrary;

        document.getElementById("btnImportLocal").onclick = doImportLocal;
        document.getElementById("btnAddExternal").onclick = doAddExternal;

        document.getElementById("btnToggleAddFromLibrary").onclick = () => {
            const isHidden = addFromLibraryPanel.style.display === "none";
            addFromLibraryPanel.style.display = isHidden ? "" : "none";
            if (isHidden) renderAddFromLibraryList();
        };

        librarySearchInPlaylist.oninput = renderAddFromLibraryList;

        // ------------------ Boot ------------------
        showLibrary();
        refreshAll();
    </script>
</body>
</html>